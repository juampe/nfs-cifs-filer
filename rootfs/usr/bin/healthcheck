#!/bin/sh
# Healthcheck: Samba (smbd), WSDD, MiniDLNA, NFS

ERRORS=0

# Check Samba (critical)
if ! pgrep -x smbd > /dev/null 2>&1; then
    echo "ERROR: Samba is not running"
    ERRORS=$((ERRORS + 1))
elif ! netstat -tlnp 2>/dev/null | grep -q ':445.*smbd' && ! ss -tlnp 2>/dev/null | grep -q ':445.*smbd'; then
    echo "ERROR: Samba not listening on port 445"
    ERRORS=$((ERRORS + 1))
fi

# Check NFS (critical)
if ! pgrep -x rpc.mountd > /dev/null 2>&1; then
    echo "ERROR: NFS mountd is not running"
    ERRORS=$((ERRORS + 1))
elif ! pgrep -x nfsd > /dev/null 2>&1 && ! pgrep rpc.nfsd > /dev/null 2>&1; then
    echo "ERROR: NFS server is not running"
    ERRORS=$((ERRORS + 1))
fi

# Check WSDD
if ! pgrep -f wsdd > /dev/null 2>&1; then
    echo "WARN: WSDD is not running"
fi

# Check MiniDLNA
if ! pgrep -x minidlnad > /dev/null 2>&1; then
    echo "WARN: MiniDLNA is not running"
fi

# Healthy if Samba and NFS are working
[ $ERRORS -eq 0 ] && exit 0 || exit 1
